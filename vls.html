<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最終版コアラ家系図ツール</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f0f8ff 100%);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 25px;
        }

        .header {
            text-align: center;
            margin-bottom: 35px;
            padding: 20px;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            border-radius: 12px;
            color: white;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .input-section {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #4caf50;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 3px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            resize: vertical;
        }

        textarea:focus {
            border-color: #4caf50;
            outline: none;
        }

        .button-group {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #e57373);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background: #cccccc !important;
            cursor: not-allowed;
            transform: none !important;
        }

        .controls-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: none;
            border: 2px solid #dee2e6;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .control-group input,
        .control-group select {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .range-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-control input[type="range"] {
            flex: 1;
            max-width: 150px;
        }

        .range-value {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        #network-container {
            border: 3px solid #4caf50;
            border-radius: 12px;
            background: white;
            margin-top: 30px;
            height: 700px;
            position: relative;
        }

        .stats-info {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-weight: bold;
            color: #2e7d32;
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 2px solid #f44336;
            color: #c62828;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-weight: bold;
        }

        .success-message {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #4caf50;
            color: #2e7d32;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-weight: bold;
        }

        /* vis.jsノードスタイル */
        .vis-network .vis-node.male {
            background-color: #42a5f5 !important;
            border-color: #1976d2 !important;
        }

        .vis-network .vis-node.female {
            background-color: #d32f2f !important;
            border-color: #b71c1c !important;
        }

        .vis-network .vis-node.unknown {
            background-color: #bdbdbd !important;
            border-color: #757575 !important;
        }

        .vis-network .vis-node.union {
            background-color: #ff9800 !important;
            border-color: #f57c00 !important;
        }

        .highlight-controls {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #4caf50;
        }

        .highlight-status {
            background: #e3f2fd;
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
            color: #1976d2;
            border: 2px solid #2196f3;
        }

        .highlight-status.active {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #4caf50;
        }

        .legend {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 2px solid #2196f3;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        .legend-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            border: 3px solid #333;
            flex-shrink: 0;
        }

        .legend-circle.male {
            background: #42a5f5;
            border-color: #1976d2;
        }

        .legend-circle.female {
            background: #d32f2f;
            border-color: #b71c1c;
        }

        .legend-circle.unknown {
            background: #bdbdbd;
            border-color: #757575;
        }

        .legend-diamond {
            width: 20px;
            height: 20px;
            background: #ff9800;
            border: 3px solid #f57c00;
            margin-right: 10px;
            transform: rotate(45deg);
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>コアラ家系図作成ツール</h1>
            <p>一部の写真は<a href="https://w.atwiki.jp/koala_wiki">コアラwiki</a>からお借りしています。</p>
            <p>作者: かた (@cold_planet_)</p>
        </div>

        <div class="input-section">
            <h3>コアラデータ入力</h3>
            <textarea id="csvInput" placeholder="CSVデータをここに貼り付けてください...

例:
個体名,性別,生年月日,父親,母親,アイコン,現在地
マックス,オス,2015-03-20,,,, 東山動植物園
ルナ,メス,2016-05-15,,,, 
コタロウ,オス,2020-06-12,マックス,ルナ,, 平川動物公園"></textarea>
            
            <div class="button-group">
                <button class="btn-primary" onclick="generateNetwork()">家系図を生成</button>
                <button class="btn-secondary" onclick="loadSampleData()">サンプルデータ</button>
                <button class="btn-secondary" onclick="loadDataFromJS()">data.jsから読み込む</button>
                <button class="btn-warning" onclick="exportNetwork()" id="exportBtn" disabled>画像として保存</button>
                <button class="btn-danger" onclick="clearAll()">すべてクリア</button>
            </div>
        </div>

        <div class="controls-section" id="controlsSection">
            <h3>表示設定</h3>
            <div class="controls-grid">
                <div class="control-group">
                    <label>レイアウト</label>
                    <select id="layoutType" onchange="updateLayout()">
                        <option value="hierarchical" selected>階層表示（推奨）</option>
                        <option value="force">力学的配置</option>
                        <option value="circular">円形配置</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>ノードサイズ</label>
                    <div class="range-control">
                        <input type="range" id="nodeSize" min="30" max="100" value="50" oninput="updateNodeSize()">
                        <span id="nodeSizeValue" class="range-value">50</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>ノード間隔（横）</label>
                    <div class="range-control">
                        <input type="range" id="nodeSpacing" min="150" max="500" value="250" oninput="updateNodeSpacing()">
                        <span id="nodeSpacingValue" class="range-value">250</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>エッジの太さ</label>
                    <div class="range-control">
                        <input type="range" id="edgeWidth" min="1" max="10" value="4" oninput="updateEdgeWidth()">
                        <span id="edgeWidthValue" class="range-value">4</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>物理演算</label>
                    <select id="physics" onchange="updatePhysics()">
                        <option value="false" selected>無効（推奨）</option>
                        <option value="true">有効</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>個体フィルタ</label>
                    <select id="individualFilter" onchange="updateFilter()">
                        <option value="">全体表示</option>
                    </select>
                </div>

                <div class="control-group">
                    <button class="btn-secondary" onclick="fitNetwork()">全体を表示</button>
                </div>
            </div>

            <div class="highlight-controls">
                <h4>ハイライト機能</h4>
                <p>個体をクリックすると、親子関係・パートナー関係が強調表示されます。物理演算を無効にすることで、ノード間隔が維持されます。</p>
                <div class="highlight-status" id="highlightStatus">
                    ハイライト: なし
                </div>
                <button class="btn-warning" onclick="clearHighlight()">ハイライトをクリア</button>
            </div>

            <div class="legend">
                <h4>凡例</h4>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-circle male"></div>
                        <span>オス（青）</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle female"></div>
                        <span>メス（赤）</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle unknown"></div>
                        <span>性別不明（グレー）</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-diamond"></div>
                        <span>夫婦結合点</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="messages"></div>
        <div class="stats-info" id="statsInfo" style="display:none;"></div>
        <div id="network-container"></div>
    </div>

    <script>
        // グローバル変数
        let koalaData = [];
        let network = null;
        let nodes, edges;
        let highlightedElements = [];
        let currentFilter = ''; // フィルタ用の変数を追加

        // 初期化
        function initialize() {
            updateDisplayValues();
            loadDataJS();
        }

        // data.jsを動的に読み込む
        function loadDataJS() {
            if (typeof window.familyData === 'undefined') {
                const script = document.createElement('script');
                script.src = './data.js';
                script.onload = () => {
                    if (typeof window.familyData !== 'undefined') {
                        showMessage(`data.jsから${window.familyData.length}件のデータを検出しました`, 'success');
                    }
                };
                script.onerror = () => {
                    console.log('data.js not found');
                };
                document.head.appendChild(script);
            }
        }

        // data.jsからデータを読み込む
        function loadDataFromJS() {
            if (typeof window.familyData === 'undefined') {
                showMessage('data.jsが読み込まれていません', 'error');
                return;
            }

            try {
                const csvData = convertFamilyDataToCSV(window.familyData);
                document.getElementById('csvInput').value = csvData;
                showMessage(`data.jsから${window.familyData.length}件のデータを読み込みました`, 'success');
            } catch (error) {
                showMessage('data.jsの変換エラー: ' + error.message, 'error');
            }
        }

        // familyDataをCSV形式に変換
        function convertFamilyDataToCSV(familyData) {
            const header = '個体名,性別,生年月日,父親,母親,アイコン,現在地';
            const rows = [header];

            const idToName = new Map();
            familyData.forEach(koala => {
                if (koala.name && koala.name.trim()) {
                    idToName.set(koala.id, koala.name.trim());
                }
            });

            familyData.forEach(koala => {
                if (!koala.name || !koala.name.trim()) return;

                const name = koala.name.trim();
                const gender = parseGender(koala.gender);
                const birthInfo = koala.born || '';
                const father = koala.fid !== undefined ? (idToName.get(koala.fid) || '') : '';
                const mother = koala.mid !== undefined ? (idToName.get(koala.mid) || '') : '';
                const icon = koala.img || '';
                const location = koala.locate || '';

                rows.push(`${name},${gender},${birthInfo},${father},${mother},${icon},${location}`);
            });

            return rows.join('\n');
        }

        // 性別を日本語に変換
        function parseGender(gender) {
            if (!gender) return '';
            const g = gender.toLowerCase();
            if (g === 'male' || g === 'オス' || g === '♂') return 'オス';
            if (g === 'female' || g === 'メス' || g === '♀') return 'メス';
            return '';
        }

        // サンプルデータ読み込み
        function loadSampleData() {
            const sampleCSV = `個体名,性別,生年月日,父親,母親,アイコン,現在地
マックス,オス,2015-03-20,,,, 東山動植物園
ダイキ,オス,2014-08-15,,,, 
ルナ,メス,2016-05-15,,,, 
サクラ,メス,2017-08-10,,,, 
ハナ,メス,2018-02-28,,,, 
ミク,メス,2015-12-03,,,, 
ユリ,メス,2016-09-22,,,, 
コタロウ,オス,2020-06-12,マックス,ルナ,, 平川動物公園
ハルカ,メス,2020-08-25,マックス,サクラ,, 
タロウ,オス,2021-03-18,マックス,ハナ,, 
ジロウ,オス,2021-07-30,ダイキ,ミク,, 
サラ,メス,2021-11-14,ダイキ,ユリ,, 
ハビ太,オス,2022-04-08,マックス,ルナ,, 
ココ,メス,2022-09-19,マックス,サクラ,, 
ピーチ,メス,2023-01-25,ダイキ,ミク,, `;
            
            document.getElementById('csvInput').value = sampleCSV;
            showMessage('サンプルデータを読み込みました', 'success');
        }

        // CSVデータ解析
        function parseKoalaData(csvText) {
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            const koalas = results.data.map((row, index) => {
                                const name = (row['個体名'] || row['名前'] || '').trim();
                                const gender = (row['性別'] || '').trim();
                                const birthDate = (row['生年月日'] || '').trim();
                                const father = (row['父親'] || '').trim();
                                const mother = (row['母親'] || '').trim();
                                const icon = (row['アイコン'] || '').trim();
                                const location = (row['現在地'] || '').trim();

                                if (!name) {
                                    throw new Error(`${index + 2}行目: 個体名が必要です`);
                                }

                                return {
                                    name,
                                    gender,
                                    birthDate,
                                    father,
                                    mother,
                                    icon,
                                    location,
                                    partners: []
                                };
                            });

                            inferPartnerRelationships(koalas);
                            resolve(koalas);
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(new Error('CSV解析エラー: ' + error.message));
                    }
                });
            });
        }

        // パートナー関係を推定
        function inferPartnerRelationships(koalas) {
            const partnerPairs = new Map();

            koalas.forEach(koala => {
                if (koala.father && koala.mother) {
                    const pairKey = [koala.father, koala.mother].sort().join('|');
                    if (!partnerPairs.has(pairKey)) {
                        partnerPairs.set(pairKey, []);
                    }
                    partnerPairs.get(pairKey).push(koala.name);
                }
            });

            partnerPairs.forEach((children, pairKey) => {
                const [parent1, parent2] = pairKey.split('|');
                
                const koala1 = koalas.find(k => k.name === parent1);
                const koala2 = koalas.find(k => k.name === parent2);
                
                if (koala1 && koala2) {
                    if (!koala1.partners.includes(parent2)) {
                        koala1.partners.push(parent2);
                    }
                    if (!koala2.partners.includes(parent1)) {
                        koala2.partners.push(parent1);
                    }
                }
            });
        }

        // ネットワーク生成
        async function generateNetwork() {
            clearMessages();
            
            if (typeof vis === 'undefined') {
                showMessage('vis.jsライブラリの読み込みに失敗しました', 'error');
                return;
            }
            
            try {
                const csvText = document.getElementById('csvInput').value.trim();
                if (!csvText) {
                    throw new Error('CSVデータを入力してください');
                }

                koalaData = await parseKoalaData(csvText);
                
                if (koalaData.length === 0) {
                    throw new Error('有効なデータが見つかりません');
                }

                createNetworkData();
                drawNetwork();

                document.getElementById('controlsSection').style.display = 'block';
                document.getElementById('exportBtn').disabled = false;
                
                // フィルタ選択肢を更新
                populateIndividualFilter();

                const stats = calculateStats(koalaData);
                document.getElementById('statsInfo').innerHTML = 
                    `統計: 総個体数 ${stats.total}匹、オス ${stats.males}匹、メス ${stats.females}匹、繁殖ペア ${stats.breedingPairs}組`;
                document.getElementById('statsInfo').style.display = 'block';

                showMessage(`家系図を生成しました（${stats.total}匹）`, 'success');

            } catch (error) {
                showMessage('エラー: ' + error.message, 'error');
            }
        }

        // ネットワークデータ作成
        function createNetworkData() {
            const nodeArray = [];
            const edgeArray = [];
            const nodeIds = new Set();

            // フィルタが適用されている場合は対象個体のみを取得
            let filteredKoalaData = koalaData;
            if (currentFilter) {
                const traceableIds = getTraceableIndividuals(currentFilter);
                filteredKoalaData = koalaData.filter(koala => traceableIds.includes(koala.name));
            }

            // 個体ノード作成
            filteredKoalaData.forEach(koala => {
                if (!nodeIds.has(koala.name)) {
                    const nodeConfig = {
                        id: koala.name,
                        label: koala.name,
                        group: getKoalaGroup(koala),
                        title: createTooltip(koala),
                        data: koala,
                        size: parseInt(document.getElementById('nodeSize').value),
                        borderWidth: 3
                    };

                    if (koala.icon && koala.icon.startsWith('http')) {
                        nodeConfig.shape = 'circularImage';
                        nodeConfig.image = koala.icon;
                    } else {
                        nodeConfig.shape = 'dot';
                    }

                    nodeArray.push(nodeConfig);
                    nodeIds.add(koala.name);
                }
            });

            // 夫婦ペアと結合ノード作成（フィルタ適用後のデータのみ）
            const coupleMap = new Map();

            filteredKoalaData.forEach(koala => {
                if (koala.father && koala.mother && 
                    nodeIds.has(koala.father) && nodeIds.has(koala.mother)) {
                    const coupleKey = [koala.father, koala.mother].sort().join('|');
                    if (!coupleMap.has(coupleKey)) {
                        coupleMap.set(coupleKey, []);
                    }
                    coupleMap.get(coupleKey).push(koala.name);
                }
            });

            coupleMap.forEach((children, coupleKey) => {
                const [parent1, parent2] = coupleKey.split('|');
                const unionNodeId = `union_${coupleKey}`;
                
                nodeArray.push({
                    id: unionNodeId,
                    label: '',
                    group: 'union',
                    title: `${parent1} と ${parent2} の結合点<br>子ども: ${children.join(', ')}`,
                    shape: 'diamond',
                    size: 20,
                    borderWidth: 3
                });
                
                nodeIds.add(unionNodeId);

                // 夫婦を結合ノードに接続
                edgeArray.push({
                    id: `marriage_${parent1}_${unionNodeId}`,
                    from: parent1,
                    to: unionNodeId,
                    width: parseInt(document.getElementById('edgeWidth').value),
                    color: { color: '#4caf50' },
                    type: 'marriage'
                });

                edgeArray.push({
                    id: `marriage_${parent2}_${unionNodeId}`,
                    from: parent2,
                    to: unionNodeId,
                    width: parseInt(document.getElementById('edgeWidth').value),
                    color: { color: '#4caf50' },
                    type: 'marriage'
                });

                // 結合ノードから子どもへの接続
                children.forEach(child => {
                    edgeArray.push({
                        id: `offspring_${unionNodeId}_${child}`,
                        from: unionNodeId,
                        to: child,
                        width: parseInt(document.getElementById('edgeWidth').value) - 1,
                        color: { color: '#ff9800' },
                        type: 'offspring',
                        arrows: { to: { enabled: true, scaleFactor: 1.2 } }
                    });
                });
            });

            nodes = new vis.DataSet(nodeArray);
            edges = new vis.DataSet(edgeArray);
        }

        // コアラグループ判定
        function getKoalaGroup(koala) {
            if (koala.gender === 'オス' || koala.gender === '♂' || koala.gender.toLowerCase() === 'male') {
                return 'male';
            } else if (koala.gender === 'メス' || koala.gender === '♀' || koala.gender.toLowerCase() === 'female') {
                return 'female';
            } else {
                return 'unknown';
            }
        }

        // ツールチップ作成
        function createTooltip(koala) {
            let tooltip = `<strong>${koala.name}</strong><br>`;
            tooltip += `性別: ${koala.gender}<br>`;
            
            if (koala.birthDate) {
                const birthInfo = parseBirthInfo(koala.birthDate);
                tooltip += `生年月日: ${birthInfo.birth}`;
                if (birthInfo.death) {
                    tooltip += ` - ${birthInfo.death}`;
                }
                if (birthInfo.age !== null) {
                    tooltip += ` (${birthInfo.age}歳)`;
                }
                tooltip += `<br>`;
            }
            
            if (koala.location) {
                tooltip += `現在地: ${koala.location}<br>`;
            }
            
            if (koala.father || koala.mother) {
                tooltip += `両親: `;
                if (koala.father) tooltip += `父 ${koala.father} `;
                if (koala.mother) tooltip += `母 ${koala.mother}`;
                tooltip += `<br>`;
            }

            const childrenCount = koalaData.filter(k => 
                k.father === koala.name || k.mother === koala.name
            ).length;
            
            if (childrenCount > 0) {
                tooltip += `子どもの数: ${childrenCount}匹<br>`;
            }
            
            return tooltip;
        }

        // 生年月日情報の解析
        function parseBirthInfo(birthString) {
            const result = { birth: null, death: null, age: null };
            
            if (birthString.includes('-')) {
                const parts = birthString.split('-');
                result.birth = parts[0].trim();
                if (parts[1] && parts[1].trim()) {
                    result.death = parts[1].trim();
                    result.age = calculateAgeAtDeath(result.birth, result.death);
                }
            } else {
                result.birth = birthString.trim();
                result.age = calculateAge(result.birth);
            }
            
            return result;
        }

        // 死亡時年齢計算
        function calculateAgeAtDeath(birthDate, deathDate) {
            try {
                const birth = new Date(birthDate);
                const death = new Date(deathDate);
                let age = death.getFullYear() - birth.getFullYear();
                const monthDiff = death.getMonth() - birth.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && death.getDate() < birth.getDate())) {
                    age--;
                }
                
                return age;
            } catch (error) {
                return null;
            }
        }

        // 年齢計算
        function calculateAge(birthDate) {
            try {
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                
                return age;
            } catch (error) {
                return null;
            }
        }

        // ネットワーク描画
        function drawNetwork() {
            const container = document.getElementById('network-container');
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                nodes: {
                    font: { size: 14 },
                    borderWidth: 3,
                    shadow: true
                },
                edges: {
                    font: { size: 12 },
                    smooth: { type: 'continuous' },
                    shadow: true
                },
                layout: getLayoutOptions(),
                physics: getPhysicsOptions(),
                interaction: {
                    selectConnectedEdges: false
                }
            };

            try {
                network = new vis.Network(container, data, options);
                
                // クリックイベントのみ設定
                network.on('click', handleNodeClick);
                
                showMessage('ネットワークを描画しました。ノードをクリックして関連を確認してください。', 'success');
            } catch (error) {
                showMessage('ネットワーク描画エラー: ' + error.message, 'error');
            }
        }

        // ノードクリック処理
        function handleNodeClick(params) {
            clearHighlight();

            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                
                if (nodeId.startsWith('union_')) {
                    const coupleKey = nodeId.replace('union_', '');
                    const [parent1, parent2] = coupleKey.split('|');
                    const children = koalaData
                        .filter(k => k.father === parent1 && k.mother === parent2)
                        .map(k => k.name);
                    
                    showMessage(`繁殖ペア: ${parent1} × ${parent2} (子ども ${children.length}匹)`, 'success');
                    return;
                }

                const koala = koalaData.find(k => k.name === nodeId);
                if (koala) {
                    highlightRelatedNodes(nodeId);
                    showKoalaDetails(koala);
                }
            }
        }

        // 関連ノードハイライト
        function highlightRelatedNodes(selectedNodeId) {
            const koala = koalaData.find(k => k.name === selectedNodeId);
            if (!koala) return;

            const nodesToHighlight = [selectedNodeId];
            const edgesToHighlight = [];

            // 親をハイライト対象に追加
            if (koala.father && koala.mother) {
                nodesToHighlight.push(koala.father, koala.mother);
                
                const unionNodeId = `union_${[koala.father, koala.mother].sort().join('|')}`;
                if (nodes.get(unionNodeId)) {
                    nodesToHighlight.push(unionNodeId);
                    edgesToHighlight.push(`marriage_${koala.father}_${unionNodeId}`);
                    edgesToHighlight.push(`marriage_${koala.mother}_${unionNodeId}`);
                    edgesToHighlight.push(`offspring_${unionNodeId}_${selectedNodeId}`);
                }
            }

            // 子どもとパートナーをハイライト対象に追加
            const children = koalaData.filter(child => child.father === selectedNodeId || child.mother === selectedNodeId);
            children.forEach(child => {
                nodesToHighlight.push(child.name);
                
                // パートナーを特定
                const partner = child.father === selectedNodeId ? child.mother : child.father;
                if (partner && !nodesToHighlight.includes(partner)) {
                    nodesToHighlight.push(partner);
                }
                
                // 結合ノードとエッジを追加
                if (partner) {
                    const unionNodeId = `union_${[selectedNodeId, partner].sort().join('|')}`;
                    if (nodes.get(unionNodeId)) {
                        nodesToHighlight.push(unionNodeId);
                        edgesToHighlight.push(`marriage_${selectedNodeId}_${unionNodeId}`);
                        edgesToHighlight.push(`marriage_${partner}_${unionNodeId}`);
                        edgesToHighlight.push(`offspring_${unionNodeId}_${child.name}`);
                    }
                }
            });

            applyHighlight(nodesToHighlight, edgesToHighlight, selectedNodeId);
            updateHighlightStatus(selectedNodeId, nodesToHighlight.length - 1);
        }

        // ハイライト適用（最適化版）
        function applyHighlight(nodeIds, edgeIds, selectedId) {
            highlightedElements = [...nodeIds, ...edgeIds];

            // ノードの一括更新用配列
            const nodeUpdates = [];
            const allNodes = nodes.get();
            
            allNodes.forEach(node => {
                if (nodeIds.includes(node.id)) {
                    const isSelected = node.id === selectedId;
                    nodeUpdates.push({
                        id: node.id,
                        borderWidth: isSelected ? 6 : 4,
                        opacity: 1,
                        shadow: {
                            enabled: true,
                            color: '#4caf50',
                            size: isSelected ? 20 : 12,
                            x: 0,
                            y: 0
                        }
                    });
                } else {
                    nodeUpdates.push({
                        id: node.id,
                        borderWidth: 2,
                        opacity: 0.3,
                        shadow: { enabled: false }
                    });
                }
            });

            // エッジの一括更新用配列
            const edgeUpdates = [];
            const allEdges = edges.get();
            
            allEdges.forEach(edge => {
                if (edgeIds.includes(edge.id)) {
                    edgeUpdates.push({
                        id: edge.id,
                        width: edge.width + 2,
                        color: { color: '#4caf50' },
                        opacity: 1,
                        shadow: {
                            enabled: true,
                            color: '#4caf50',
                            size: 8,
                            x: 0,
                            y: 0
                        }
                    });
                } else {
                    edgeUpdates.push({
                        id: edge.id,
                        opacity: 0.2,
                        shadow: { enabled: false }
                    });
                }
            });

            // 一括更新を実行（パフォーマンス向上）
            nodes.update(nodeUpdates);
            edges.update(edgeUpdates);
        }

        // ハイライトクリア（最適化版）
        function clearHighlight() {
            if (highlightedElements.length === 0) return;

            // ノードの一括リセット用配列
            const nodeUpdates = [];
            const allNodes = nodes.get();
            
            allNodes.forEach(node => {
                nodeUpdates.push({
                    id: node.id,
                    borderWidth: 3,
                    opacity: 1,
                    shadow: { 
                        enabled: true, 
                        color: 'rgba(0,0,0,0.5)', 
                        size: 10,
                        x: 2,
                        y: 2
                    }
                });
            });

            // エッジの一括リセット用配列
            const edgeUpdates = [];
            const allEdges = edges.get();
            
            allEdges.forEach(edge => {
                const originalColor = edge.type === 'marriage' ? '#4caf50' : '#ff9800';
                const originalWidth = edge.type === 'offspring' ? 
                    parseInt(document.getElementById('edgeWidth').value) - 1 : 
                    parseInt(document.getElementById('edgeWidth').value);
                
                edgeUpdates.push({
                    id: edge.id,
                    width: originalWidth,
                    color: { color: originalColor },
                    opacity: 1,
                    shadow: { 
                        enabled: true,
                        color: 'rgba(0,0,0,0.3)',
                        size: 5,
                        x: 1,
                        y: 1
                    }
                });
            });

            // 一括更新を実行
            nodes.update(nodeUpdates);
            edges.update(edgeUpdates);

            highlightedElements = [];
            updateHighlightStatus(null, 0);
        }

        // 個体フィルタのセレクトボックスを更新
        function populateIndividualFilter() {
            const filterSelect = document.getElementById('individualFilter');
            
            // 既存の選択肢をクリア（最初の「全体表示」は残す）
            while (filterSelect.children.length > 1) {
                filterSelect.removeChild(filterSelect.lastChild);
            }
            
            // 個体名でソートして選択肢を追加
            const sortedKoalas = koalaData.sort((a, b) => a.name.localeCompare(b.name));
            sortedKoalas.forEach(koala => {
                const option = document.createElement('option');
                option.value = koala.name;
                option.textContent = `${koala.name} (${koala.gender})`;
                filterSelect.appendChild(option);
            });
        }

        // 選択した個体から辿れるすべての個体を取得
        function getTraceableIndividuals(selectedId) {
            const traceable = new Set();
            const toProcess = [selectedId];
            
            // 再帰的に関連個体を探索
            while (toProcess.length > 0) {
                const currentId = toProcess.pop();
                if (traceable.has(currentId)) continue;
                
                traceable.add(currentId);
                const currentKoala = koalaData.find(k => k.name === currentId);
                if (!currentKoala) continue;
                
                // 両親を追加
                if (currentKoala.father && !traceable.has(currentKoala.father)) {
                    toProcess.push(currentKoala.father);
                }
                if (currentKoala.mother && !traceable.has(currentKoala.mother)) {
                    toProcess.push(currentKoala.mother);
                }
                
                // 子どもを追加
                const children = koalaData.filter(k => 
                    k.father === currentId || k.mother === currentId
                );
                children.forEach(child => {
                    if (!traceable.has(child.name)) {
                        toProcess.push(child.name);
                    }
                });
                
                // パートナーを追加
                currentKoala.partners.forEach(partner => {
                    if (!traceable.has(partner)) {
                        toProcess.push(partner);
                    }
                });
                
                // 兄弟姉妹を追加
                if (currentKoala.father && currentKoala.mother) {
                    const siblings = koalaData.filter(k => 
                        k.father === currentKoala.father && 
                        k.mother === currentKoala.mother &&
                        k.name !== currentId
                    );
                    siblings.forEach(sibling => {
                        if (!traceable.has(sibling.name)) {
                            toProcess.push(sibling.name);
                        }
                    });
                }
            }
            
            return Array.from(traceable);
        }

        // フィルタ更新処理
        function updateFilter() {
            const filterValue = document.getElementById('individualFilter').value;
            currentFilter = filterValue;
            
            // ハイライトをクリア
            clearHighlight();
            
            // ネットワークを再生成
            if (koalaData.length > 0) {
                createNetworkData();
                
                // 既存のネットワークがある場合は破棄
                if (network) {
                    network.destroy();
                }
                
                drawNetwork();
                
                // メッセージを表示
                if (filterValue) {
                    const filteredCount = nodes.length - edges.get().filter(e => e.type === 'marriage').length / 2;
                    showMessage(`フィルタを適用しました: ${filterValue} とその関連個体（${filteredCount}匹を表示）`, 'success');
                } else {
                    showMessage('フィルタをクリアしました（全体表示）', 'success');
                }
            }
        }

        // レイアウトオプション取得
        function getLayoutOptions() {
            const layoutType = document.getElementById('layoutType').value;
            const nodeSpacing = parseInt(document.getElementById('nodeSpacing').value);
            
            switch (layoutType) {
                case 'hierarchical':
                    return {
                        hierarchical: {
                            direction: 'UD',
                            sortMethod: 'directed',
                            nodeSpacing: nodeSpacing,
                            levelSeparation: 200,
                            treeSpacing: nodeSpacing + 50,
                            blockShifting: true,
                            edgeMinimization: true,
                            parentCentralization: true
                        }
                    };
                case 'force':
                    return { improvedLayout: true, randomSeed: 42 };
                case 'circular':
                    return { randomSeed: 2 };
                default:
                    return {};
            }
        }

        // 物理演算オプション取得
        function getPhysicsOptions() {
            const layoutType = document.getElementById('layoutType').value;
            const physicsEnabled = document.getElementById('physics').value === 'true';
            
            if (layoutType === 'hierarchical') {
                // 階層レイアウトでは物理演算を無効にしてノードの位置を固定
                return {
                    enabled: false,
                    stabilization: { iterations: 0 }
                };
            } else if (physicsEnabled) {
                // その他のレイアウトで物理演算が有効な場合
                return {
                    enabled: true,
                    stabilization: { iterations: 200 },
                    solver: 'barnesHut',
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.1,
                        springLength: 200,
                        springConstant: 0.05,
                        damping: 0.4
                    }
                };
            } else {
                // 物理演算無効
                return {
                    enabled: false,
                    stabilization: { iterations: 0 }
                };
            }
        }

        // 各種更新関数
        function updateLayout() {
            if (network) {
                const options = {
                    layout: getLayoutOptions(),
                    physics: getPhysicsOptions()
                };
                network.setOptions(options);
                network.redraw();
            }
        }

        function updateNodeSize() {
            const size = parseInt(document.getElementById('nodeSize').value);
            document.getElementById('nodeSizeValue').textContent = size;
            
            if (network && nodes) {
                const allNodes = nodes.get();
                allNodes.forEach(node => {
                    nodes.update({
                        id: node.id,
                        size: node.group === 'union' ? 20 : size
                    });
                });
            }
        }

        function updateNodeSpacing() {
            const spacing = parseInt(document.getElementById('nodeSpacing').value);
            document.getElementById('nodeSpacingValue').textContent = spacing;
            updateLayout();
        }

        function updateEdgeWidth() {
            const width = parseInt(document.getElementById('edgeWidth').value);
            document.getElementById('edgeWidthValue').textContent = width;
            
            if (network && edges) {
                const allEdges = edges.get();
                allEdges.forEach(edge => {
                    const newWidth = edge.type === 'offspring' ? width - 1 : width;
                    edges.update({
                        id: edge.id,
                        width: newWidth
                    });
                });
            }
        }

        function updatePhysics() {
            if (network) {
                const options = {
                    physics: getPhysicsOptions()
                };
                network.setOptions(options);
            }
        }

        function updateDisplayValues() {
            document.getElementById('nodeSizeValue').textContent = document.getElementById('nodeSize').value;
            document.getElementById('edgeWidthValue').textContent = document.getElementById('edgeWidth').value;
            document.getElementById('nodeSpacingValue').textContent = document.getElementById('nodeSpacing').value;
        }

        function fitNetwork() {
            if (network) {
                network.fit({
                    animation: { duration: 1000, easingFunction: 'easeInOutQuad' }
                });
            }
        }

        // ハイライトステータス更新
        function updateHighlightStatus(selectedName, relatedCount) {
            const statusDiv = document.getElementById('highlightStatus');
            if (selectedName) {
                statusDiv.innerHTML = `ハイライト: <strong>${selectedName}</strong> と関連個体 ${relatedCount}匹`;
                statusDiv.className = 'highlight-status active';
            } else {
                statusDiv.innerHTML = 'ハイライト: なし';
                statusDiv.className = 'highlight-status';
            }
        }

        // コアラ詳細表示
        function showKoalaDetails(koala) {
            const childrenCount = koalaData.filter(k => 
                k.father === koala.name || k.mother === koala.name
            ).length;

            const children = koalaData
                .filter(k => k.father === koala.name || k.mother === koala.name)
                .map(k => k.name);

            const birthInfo = koala.birthDate ? parseBirthInfo(koala.birthDate) : { birth: '不明', death: null, age: null };

            const details = `
                ${koala.name} の詳細情報<br>
                性別: ${koala.gender}<br>
                生年月日: ${birthInfo.birth || '不明'}<br>
                ${birthInfo.death ? `死亡日: ${birthInfo.death}<br>` : ''}
                ${birthInfo.age !== null ? `年齢: ${birthInfo.age}歳<br>` : ''}
                現在地: ${koala.location || '不明'}<br>
                両親: ${koala.father || '不明'} × ${koala.mother || '不明'}<br>
                繁殖パートナー数: ${koala.partners.length}匹<br>
                子どもの数: ${childrenCount}匹<br>
                子ども: ${children.join(', ') || 'なし'}
            `;
            showMessage(details, 'success');
        }

        // 統計計算
        function calculateStats(data) {
            const males = data.filter(k => getKoalaGroup(k) === 'male').length;
            const females = data.filter(k => getKoalaGroup(k) === 'female').length;
            
            const breedingPairs = new Set();
            data.forEach(koala => {
                koala.partners.forEach(partner => {
                    const pair = [koala.name, partner].sort().join('|');
                    breedingPairs.add(pair);
                });
            });

            return {
                total: data.length,
                males,
                females,
                breedingPairs: breedingPairs.size
            };
        }

        // ネットワークエクスポート
        function exportNetwork() {
            try {
                if (!network) {
                    showMessage('家系図が生成されていません', 'error');
                    return;
                }

                const canvas = network.canvas.body.container.children[0];
                if (canvas && canvas.toDataURL) {
                    const dataURL = canvas.toDataURL('image/png', 1.0);
                    const link = document.createElement('a');
                    link.download = `コアラ家系図_${new Date().getTime()}.png`;
                    link.href = dataURL;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showMessage('画像をダウンロードしました', 'success');
                } else {
                    showMessage('エクスポート機能に制限があります', 'error');
                }
            } catch (error) {
                showMessage('エクスポートできませんでした', 'error');
            }
        }

        // すべてクリア
        function clearAll() {
            document.getElementById('csvInput').value = '';
            
            if (network) {
                network.destroy();
                network = null;
            }
            
            document.getElementById('network-container').innerHTML = '';
            document.getElementById('controlsSection').style.display = 'none';
            document.getElementById('statsInfo').style.display = 'none';
            document.getElementById('exportBtn').disabled = true;
            
            // フィルタもリセット
            currentFilter = '';
            document.getElementById('individualFilter').value = '';
            
            koalaData = [];
            nodes = null;
            edges = null;
            highlightedElements = [];
            
            clearMessages();
            showMessage('すべてクリアしました', 'success');
        }

        // メッセージ表示
        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            let className = 'success-message';
            
            if (type === 'error') {
                className = 'error-message';
            } else if (type === 'info') {
                className = 'stats-info';
            }
            
            messagesDiv.innerHTML = `<div class="${className}">${text}</div>`;
            
            setTimeout(() => {
                if (messagesDiv.innerHTML.includes(text)) {
                    messagesDiv.innerHTML = '';
                }
            }, 6000);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // 初期化実行
        window.addEventListener('load', function() {
            setTimeout(initialize, 100);
        });

        // vis.js代替読み込み
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (typeof vis === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/vis@4.21.0/dist/vis.min.js';
                    script.onload = () => initialize();
                    script.onerror = () => showMessage('ライブラリの読み込みに失敗しました', 'error');
                    document.head.appendChild(script);
                }
            }, 1000);
        });
    </script>
</body>
</html>